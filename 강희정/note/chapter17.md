# 17장. 플로우 연산자

# 17.1 플로우 연산자로 플로우 조작

중간 연산자

- 코드를 실행하지 않고 변경된 플로우를 반환

최종 연산자

- 컬렉션, 개별 원소, 계산된 값을 반환
- 아무 값도 반환하지 않으면서 플로우를 수집
- 실제 코드를 실행

# 17.2 중간 연산자 - 업스트림 플로우에 적용, 다운스트림 플로우를 반환

업스트림 플로우

- 연산자가 적용되는 플로우 (연산자가 호출되는 플로우)

다운스트림 플로우

- 중간 연산자가 반환하는 플로우
- 또 다른 연산자의 업스트림 플로우로 작용

중간 연산자가 호출되더라도 플로우 코드가 실제로 실행되지는 않음 → 반환된 플로우는 콜드 상태

## 17.2.1 transform - 업스트림 원소별로 임의의 값을 배출

```kotlin
fun main() {
		val names = flow {
				emit("Jo")
				emit("May")
				emit("Sue")
		}
		val upperAndLowercasedNames = names.transform {
				emit(it.uppercase())
				emit(it.lowercase())
		}
		runBlocking {
				upperAndLowercasedNames.collect { print("$it ")}
		}
		
		// JO jo MAY may SUE sue
}
```

- 업스트림 플로우의 각 원소에 대해 원하는 만큼의 원소를 다운스트림 플로우에 배출

flowOf로 줄일 수 있음

```kotlin
val names = flow {
				emit("Jo")
				emit("May")
				emit("Sue")
		}
		val upperAndLowercasedNames = names.transform {
				emit(it.uppercase())
				emit(it.lowercase())
		}

// 이거를..

val names = flowOf("Jo", "May", "Sue") 
```

## 17.2.2 take - 플로우 취소

```kotlin
fun main() {
		val temps = getTemperatures()
		temps
				.take(5)  // 5번 배출 후 취소
				.collect {
					log(it)
				}
}
```

- 연산자가 지정한 조건이 더 이상 유효하지 않을 때 업스트림 플로우가 취소
- 더 이상 원소가 배출되지 않음

## 17.2.3 플로우의 각 단계 후킹: onStart, onEach, onCompletion, onEmpty

아래 메소드들을 사용하면 플로우의 생명주기를 확인할 수 있다.

onCompletion

- 플로우가 정상 종료, 취소, 예외로 종료된 후에 호출되는 람다 지정
- 플로우 생명주기의 특정 단계에서 작업을 수행할 수 있는 중간 연산자

onStart

- 플로우의 수집이 시작될 때 첫 번째 배출이 일어나기 전에 실행

onEach

- 업스트림 플로우에서 배출된 각 원소에 대해 작업을 수행한 후 - 다운스트림 플로우에 전달

onEmpty

- 원소를 배출하지 않고 종료되는 플로우
- 로직을 추가로 수행하거나 기본값을 제공

## 17.2.4 buffer: 다운스트림 연산자와 수집자를 위한 원소 버퍼링

값 생산자는 수집자가 이전 원소를 처리할 때 까지 작업을 중단함

원소가 배출되면 다운스트림 플로우가 해당 원소를 처리할 때까지 생산자 코드는 계속죄니 않음

buffer 연산자

- 수집자가 원소를 처리할 때 까지 생산자를 기다리지 않고 원소 생성
- 다운스트림 플로우가 배출된 원소를 처리하느라 바쁜 동안 업스트림 플로우가 원소를 배출
- onBufferOverFlow 파라미터를 통해 버퍼 용량이 초과될 때 발생할 일 지정 가능

## 17.2.5: conflate - 중간값을 버리는 연산

- 수집가가 바쁜 동안 배출된 항목을 버림
- 느린 수집자가 플로우에서 최신 원소만 처리

## 17.2.6 debounce - 일정 시간 동안 값을 필터링

- 업스트림에서 원소가 배출되지 않은 상태로 정해진 타임아웃 시간이 지나야만 항목을 다운스트림 플로우로 배출

## 17.2.7 flowOn - 플로우가 실행되는 코루틴 컨텍스트 변경

코루틴 컨텍스트 → 플로우 로직이 실행되는 위치 결정

수집 프로세스는 collect가 호출된 컨텍스트에서 실행

flowOn

- 처리 파이프라인의 일부를 다른 디스패처나 다른 코루틴 컨텍스트에서 실행
- 코루틴 컨텍스트 조정
- 업스트림 플로우의 디스패처에만 영향을 미치고, 다운스트림 플로우에는 영향을 받지 않음

# 17.3 커스텀 중간 연산자 만들기

중간 연산자는 동시에 수집자와 생산자의 역할을 함

업스트림 플로우에서 원소 수집 → 변환/부수 효과/사용자 정의 동작 수행 → 다운스트림 플로우에 새 원소 배출

이 패턴을 지켜서 커스텀 중간 연산자 만들기 가능

# 17.4 최종 연산자는 업스트림 플로우를 실행하고 값을 계산

중간 연산자 → 실제로 코드를 실행하지 않음

최종 연산자 → 실행 담당

- 단일 값이나 값의 컬렉션 계산
- 플로우의 실행을 촉발시켜 지정된 연산과 부수 효과를 수행
- 업스트림 플로우의 실행을 담당하므로 항상 일시 중단 함수